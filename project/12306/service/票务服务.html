<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.67">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>票务服务 | zzys</title><meta name="description" content="zzys的个人博客">
    <link rel="preload" href="/assets/style-ec18e87d.css" as="style"><link rel="stylesheet" href="/assets/style-ec18e87d.css">
    <link rel="modulepreload" href="/assets/app-20538318.js"><link rel="modulepreload" href="/assets/票务服务.html-5bb57784.js"><link rel="modulepreload" href="/assets/票务服务.html-8a828469.js"><link rel="prefetch" href="/assets/index.html-1124f69b.js" as="script"><link rel="prefetch" href="/assets/index.html-b5ca648f.js" as="script"><link rel="prefetch" href="/assets/JUC.html-b947128f.js" as="script"><link rel="prefetch" href="/assets/Java.html-e71f1d55.js" as="script"><link rel="prefetch" href="/assets/index.html-bec769cf.js" as="script"><link rel="prefetch" href="/assets/Redis.html-db0c73b7.js" as="script"><link rel="prefetch" href="/assets/algorithm.html-e08339d8.js" as="script"><link rel="prefetch" href="/assets/mysql.html-6397606b.js" as="script"><link rel="prefetch" href="/assets/network.html-4f45418e.js" as="script"><link rel="prefetch" href="/assets/spring.html-cda4aba9.js" as="script"><link rel="prefetch" href="/assets/sundry.html-fffeb8dd.js" as="script"><link rel="prefetch" href="/assets/markdown.html-da1a35cd.js" as="script"><link rel="prefetch" href="/assets/mermaid使用.html-3fbe0211.js" as="script"><link rel="prefetch" href="/assets/how-to-learn.html-5b83d000.js" as="script"><link rel="prefetch" href="/assets/DFS、BFS.html-0152ce7c.js" as="script"><link rel="prefetch" href="/assets/KMP、Trie.html-dc92ba21.js" as="script"><link rel="prefetch" href="/assets/二分问题.html-aac3900c.js" as="script"><link rel="prefetch" href="/assets/位运算、离散化、区间合并.html-95650150.js" as="script"><link rel="prefetch" href="/assets/前缀和.html-13bb620c.js" as="script"><link rel="prefetch" href="/assets/双指针.html-93090f76.js" as="script"><link rel="prefetch" href="/assets/堆、哈希.html-241abe1d.js" as="script"><link rel="prefetch" href="/assets/差分.html-b7e4cfd1.js" as="script"><link rel="prefetch" href="/assets/index.html-e5a6ceab.js" as="script"><link rel="prefetch" href="/assets/IO多路复用.html-b72a10af.js" as="script"><link rel="prefetch" href="/assets/kernel-bypass.html-facea451.js" as="script"><link rel="prefetch" href="/assets/kernel-user-buffer.html-f9361e59.js" as="script"><link rel="prefetch" href="/assets/page-cache.html-682e229c.js" as="script"><link rel="prefetch" href="/assets/零拷贝.html-cf38ad35.js" as="script"><link rel="prefetch" href="/assets/InnoDB存储引擎.html-70e01e32.js" as="script"><link rel="prefetch" href="/assets/事务.html-d355871a.js" as="script"><link rel="prefetch" href="/assets/索引.html-d48460b1.js" as="script"><link rel="prefetch" href="/assets/锁.html-290c3d9a.js" as="script"><link rel="prefetch" href="/assets/COW-写时复制.html-607e38a6.js" as="script"><link rel="prefetch" href="/assets/snowflakeid.html-891ca13d.js" as="script"><link rel="prefetch" href="/assets/两阶段提交.html-f1cd283a.js" as="script"><link rel="prefetch" href="/assets/分布式锁.html-dbe6fb5f.js" as="script"><link rel="prefetch" href="/assets/幂等.html-52411ecf.js" as="script"><link rel="prefetch" href="/assets/秒杀场景.html-632fc29c.js" as="script"><link rel="prefetch" href="/assets/限流.html-140ddd4d.js" as="script"><link rel="prefetch" href="/assets/Golang-万声音乐-实习-23-12-27.html-28b6bfe4.js" as="script"><link rel="prefetch" href="/assets/Golang-百度-实习-23-12-11.html-049f9e2c.js" as="script"><link rel="prefetch" href="/assets/Java-喜马拉雅-实习-23-8-21.html-065a1c40.js" as="script"><link rel="prefetch" href="/assets/Java-数新网络-实习-23-12-07.html-cacab6ef.js" as="script"><link rel="prefetch" href="/assets/go.html-fd549940.js" as="script"><link rel="prefetch" href="/assets/java.html-94772974.js" as="script"><link rel="prefetch" href="/assets/index.html-2bac24fc.js" as="script"><link rel="prefetch" href="/assets/数据库表设计.html-155d4faa.js" as="script"><link rel="prefetch" href="/assets/测试.html-b1b1df80.js" as="script"><link rel="prefetch" href="/assets/组件开发.html-3811c884.js" as="script"><link rel="prefetch" href="/assets/项目准备.html-19019ac3.js" as="script"><link rel="prefetch" href="/assets/AOP.html-08519e3c.js" as="script"><link rel="prefetch" href="/assets/IOC.html-bbb032df.js" as="script"><link rel="prefetch" href="/assets/JdbcTemplate-Transaction.html-45ebad5a.js" as="script"><link rel="prefetch" href="/assets/MVC.html-217b44a6.js" as="script"><link rel="prefetch" href="/assets/DP.html-40b096d3.js" as="script"><link rel="prefetch" href="/assets/线性DP.html-6abac9c1.js" as="script"><link rel="prefetch" href="/assets/背包问题.html-f78447ad.js" as="script"><link rel="prefetch" href="/assets/归并排序.html-1acadf46.js" as="script"><link rel="prefetch" href="/assets/快速排序.html-09eb791d.js" as="script"><link rel="prefetch" href="/assets/单链表和双链表的数组实现.html-bf919e6d.js" as="script"><link rel="prefetch" href="/assets/并查集.html-66337019.js" as="script"><link rel="prefetch" href="/assets/栈和队列.html-77c4e30b.js" as="script"><link rel="prefetch" href="/assets/树状数组和线段树.html-5a392d61.js" as="script"><link rel="prefetch" href="/assets/图相关的基本算法.html-3374d688.js" as="script"><link rel="prefetch" href="/assets/树、图的存储和遍历.html-7dfcf155.js" as="script"><link rel="prefetch" href="/assets/DesignPattern.html-d1e8d094.js" as="script"><link rel="prefetch" href="/assets/builder.html-30f560af.js" as="script"><link rel="prefetch" href="/assets/chain.html-ed1b2acb.js" as="script"><link rel="prefetch" href="/assets/strategy.html-1d5899e0.js" as="script"><link rel="prefetch" href="/assets/golang-plugin.html-47c8f36c.js" as="script"><link rel="prefetch" href="/assets/golang基础入门.html-afaf7ee0.js" as="script"><link rel="prefetch" href="/assets/index.html-d0dd1a10.js" as="script"><link rel="prefetch" href="/assets/SPI.html-8a3365b2.js" as="script"><link rel="prefetch" href="/assets/jvm.html-e270154b.js" as="script"><link rel="prefetch" href="/assets/ruoyi-vue启动配置.html-90198d7b.js" as="script"><link rel="prefetch" href="/assets/redis使用场景.html-34c00e53.js" as="script"><link rel="prefetch" href="/assets/redis持久化.html-bfc1cefc.js" as="script"><link rel="prefetch" href="/assets/rust入门01-基础配置.html-e34a4fb6.js" as="script"><link rel="prefetch" href="/assets/springboot发布订阅机制.html-5175d1fa.js" as="script"><link rel="prefetch" href="/assets/动手写starter.html-c60b47b8.js" as="script"><link rel="prefetch" href="/assets/自定义spring-cloud-gateway-filter.html-d11e8c8b.js" as="script"><link rel="prefetch" href="/assets/非spring管理的类使用bean.html-9680c239.js" as="script"><link rel="prefetch" href="/assets/C编程杂记.html-ff5c1519.js" as="script"><link rel="prefetch" href="/assets/Makefile.html-7a575781.js" as="script"><link rel="prefetch" href="/assets/risc-v.html-abe15f5f.js" as="script"><link rel="prefetch" href="/assets/computer-summary.html-39fac1ff.js" as="script"><link rel="prefetch" href="/assets/system-bus.html-17a5cf43.js" as="script"><link rel="prefetch" href="/assets/汇编下的函数调用.html-57a70b1c.js" as="script"><link rel="prefetch" href="/assets/csapp-信息的表示和处理.html-90b44a6a.js" as="script"><link rel="prefetch" href="/assets/csapp-程序的机器级表示(1).html-340c19c9.js" as="script"><link rel="prefetch" href="/assets/csapp-程序的机器级表示(2).html-31014b89.js" as="script"><link rel="prefetch" href="/assets/network-ttd-application.html-e80964b6.js" as="script"><link rel="prefetch" href="/assets/network-ttd-summary.html-caf53cba.js" as="script"><link rel="prefetch" href="/assets/snmp-Java.html-c909064d.js" as="script"><link rel="prefetch" href="/assets/snmp压力测试.html-39568e54.js" as="script"><link rel="prefetch" href="/assets/ostep-concurrency.html-6d1ea898.js" as="script"><link rel="prefetch" href="/assets/ostep-persistence.html-09c90a2a.js" as="script"><link rel="prefetch" href="/assets/ostep-virtualization-cpu.html-d1249a4e.js" as="script"><link rel="prefetch" href="/assets/ostep-virtualization-memory.html-b89f52b2.js" as="script"><link rel="prefetch" href="/assets/CPU缓存一致性.html-4f7e276a.js" as="script"><link rel="prefetch" href="/assets/关于提问.html-d1087a4f.js" as="script"><link rel="prefetch" href="/assets/Backup-VMware.html-7c28803d.js" as="script"><link rel="prefetch" href="/assets/Frangipani.html-efd69a09.js" as="script"><link rel="prefetch" href="/assets/GFS.html-c0190339.js" as="script"><link rel="prefetch" href="/assets/Introduction-MapReduce.html-6d51a2e9.js" as="script"><link rel="prefetch" href="/assets/index.html-5b815926.js" as="script"><link rel="prefetch" href="/assets/Spanner.html-b14643bf.js" as="script"><link rel="prefetch" href="/assets/Zookeeper.html-70da7092.js" as="script"><link rel="prefetch" href="/assets/分布式事务.html-5b0c0d47.js" as="script"><link rel="prefetch" href="/assets/链式复制.html-89fe6b95.js" as="script"><link rel="prefetch" href="/assets/Angular基础入门.html-9caaa6fe.js" as="script"><link rel="prefetch" href="/assets/Angular环境配置和基础认知.html-64107121.js" as="script"><link rel="prefetch" href="/assets/ES6-01 let和const.html-ff066299.js" as="script"><link rel="prefetch" href="/assets/ES6-02 解构赋值.html-d71d95a8.js" as="script"><link rel="prefetch" href="/assets/ES6-03 class.html-a18531b4.js" as="script"><link rel="prefetch" href="/assets/ES6-04 ES6新增用法.html-44208019.js" as="script"><link rel="prefetch" href="/assets/ES6-05 Symbol.html-60bc338b.js" as="script"><link rel="prefetch" href="/assets/ES6-06 Module的导入和导出.html-b047a5c9.js" as="script"><link rel="prefetch" href="/assets/最长系列.html-ae919bcf.js" as="script"><link rel="prefetch" href="/assets/反转链表.html-71d96c63.js" as="script"><link rel="prefetch" href="/assets/合并链表.html-7e16bf84.js" as="script"><link rel="prefetch" href="/assets/数的二次方根.html-09e9cc4d.js" as="script"><link rel="prefetch" href="/assets/组合.html-2eea3f6d.js" as="script"><link rel="prefetch" href="/assets/ebpf杂记.html-ef72f24c.js" as="script"><link rel="prefetch" href="/assets/支付服务.html-a1d43d44.js" as="script"><link rel="prefetch" href="/assets/用户服务.html-f9de0dca.js" as="script"><link rel="prefetch" href="/assets/订单服务.html-a9509189.js" as="script"><link rel="prefetch" href="/assets/Redis.html-d7c24a25.js" as="script"><link rel="prefetch" href="/assets/RocketMq.html-a2e7cc56.js" as="script"><link rel="prefetch" href="/assets/go-zero入门实践.html-3ac3732f.js" as="script"><link rel="prefetch" href="/assets/Basic.html-394238ab.js" as="script"><link rel="prefetch" href="/assets/Collction.html-8f5a4579.js" as="script"><link rel="prefetch" href="/assets/JDK动态代理.html-558bcf44.js" as="script"><link rel="prefetch" href="/assets/ThreadLocal.html-56b3c13b.js" as="script"><link rel="prefetch" href="/assets/enum.html-a0d9e8a9.js" as="script"><link rel="prefetch" href="/assets/this与super.html-dfcab97c.js" as="script"><link rel="prefetch" href="/assets/方法调用.html-8663b59b.js" as="script"><link rel="prefetch" href="/assets/泛型.html-a3b1e955.js" as="script"><link rel="prefetch" href="/assets/juc.html-aca7fee8.js" as="script"><link rel="prefetch" href="/assets/快速消费线程池.html-b751f9c8.js" as="script"><link rel="prefetch" href="/assets/summary-question.html-7bbf36ce.js" as="script"><link rel="prefetch" href="/assets/MapReduce.html-cbf2c0fd.js" as="script"><link rel="prefetch" href="/assets/404.html-5b1f7f3d.js" as="script"><link rel="prefetch" href="/assets/index.html-44996371.js" as="script"><link rel="prefetch" href="/assets/index.html-e92be3ae.js" as="script"><link rel="prefetch" href="/assets/JUC.html-887c05ff.js" as="script"><link rel="prefetch" href="/assets/Java.html-7b4b17b6.js" as="script"><link rel="prefetch" href="/assets/index.html-5984488a.js" as="script"><link rel="prefetch" href="/assets/Redis.html-2b56049a.js" as="script"><link rel="prefetch" href="/assets/algorithm.html-df207cf9.js" as="script"><link rel="prefetch" href="/assets/mysql.html-b4d641c4.js" as="script"><link rel="prefetch" href="/assets/network.html-9767e8ee.js" as="script"><link rel="prefetch" href="/assets/spring.html-296cbbd8.js" as="script"><link rel="prefetch" href="/assets/sundry.html-06734938.js" as="script"><link rel="prefetch" href="/assets/markdown.html-ef1eae30.js" as="script"><link rel="prefetch" href="/assets/mermaid使用.html-ce9d6f43.js" as="script"><link rel="prefetch" href="/assets/how-to-learn.html-73c08c01.js" as="script"><link rel="prefetch" href="/assets/DFS、BFS.html-e1fbd187.js" as="script"><link rel="prefetch" href="/assets/KMP、Trie.html-d811b3aa.js" as="script"><link rel="prefetch" href="/assets/二分问题.html-264c5765.js" as="script"><link rel="prefetch" href="/assets/位运算、离散化、区间合并.html-a9ddee85.js" as="script"><link rel="prefetch" href="/assets/前缀和.html-c20ad3d5.js" as="script"><link rel="prefetch" href="/assets/双指针.html-0a61aa72.js" as="script"><link rel="prefetch" href="/assets/堆、哈希.html-69306e0d.js" as="script"><link rel="prefetch" href="/assets/差分.html-b1a92e71.js" as="script"><link rel="prefetch" href="/assets/index.html-2908654b.js" as="script"><link rel="prefetch" href="/assets/IO多路复用.html-4458e9c4.js" as="script"><link rel="prefetch" href="/assets/kernel-bypass.html-ee662e08.js" as="script"><link rel="prefetch" href="/assets/kernel-user-buffer.html-40efe7f2.js" as="script"><link rel="prefetch" href="/assets/page-cache.html-42117d5d.js" as="script"><link rel="prefetch" href="/assets/零拷贝.html-db16c5d0.js" as="script"><link rel="prefetch" href="/assets/InnoDB存储引擎.html-8f0cb0cc.js" as="script"><link rel="prefetch" href="/assets/事务.html-292f44da.js" as="script"><link rel="prefetch" href="/assets/索引.html-f95e279e.js" as="script"><link rel="prefetch" href="/assets/锁.html-6fdabc58.js" as="script"><link rel="prefetch" href="/assets/COW-写时复制.html-121aff84.js" as="script"><link rel="prefetch" href="/assets/snowflakeid.html-f89b7bc0.js" as="script"><link rel="prefetch" href="/assets/两阶段提交.html-35cb4496.js" as="script"><link rel="prefetch" href="/assets/分布式锁.html-ddfe53c1.js" as="script"><link rel="prefetch" href="/assets/幂等.html-0c9f98a2.js" as="script"><link rel="prefetch" href="/assets/秒杀场景.html-54be4769.js" as="script"><link rel="prefetch" href="/assets/限流.html-c9e4b631.js" as="script"><link rel="prefetch" href="/assets/Golang-万声音乐-实习-23-12-27.html-3a5dfd57.js" as="script"><link rel="prefetch" href="/assets/Golang-百度-实习-23-12-11.html-9207187e.js" as="script"><link rel="prefetch" href="/assets/Java-喜马拉雅-实习-23-8-21.html-6b0ebc76.js" as="script"><link rel="prefetch" href="/assets/Java-数新网络-实习-23-12-07.html-3c624790.js" as="script"><link rel="prefetch" href="/assets/go.html-735e06ad.js" as="script"><link rel="prefetch" href="/assets/java.html-0f80f749.js" as="script"><link rel="prefetch" href="/assets/index.html-a51412db.js" as="script"><link rel="prefetch" href="/assets/数据库表设计.html-fc478905.js" as="script"><link rel="prefetch" href="/assets/测试.html-0c7ea1c7.js" as="script"><link rel="prefetch" href="/assets/组件开发.html-4ec7407e.js" as="script"><link rel="prefetch" href="/assets/项目准备.html-36949014.js" as="script"><link rel="prefetch" href="/assets/AOP.html-99152493.js" as="script"><link rel="prefetch" href="/assets/IOC.html-40d81f53.js" as="script"><link rel="prefetch" href="/assets/JdbcTemplate-Transaction.html-01a0af06.js" as="script"><link rel="prefetch" href="/assets/MVC.html-321cb134.js" as="script"><link rel="prefetch" href="/assets/DP.html-cdf50853.js" as="script"><link rel="prefetch" href="/assets/线性DP.html-c5df8114.js" as="script"><link rel="prefetch" href="/assets/背包问题.html-47b19b73.js" as="script"><link rel="prefetch" href="/assets/归并排序.html-ae6b3c3c.js" as="script"><link rel="prefetch" href="/assets/快速排序.html-6e652588.js" as="script"><link rel="prefetch" href="/assets/单链表和双链表的数组实现.html-adf0dc04.js" as="script"><link rel="prefetch" href="/assets/并查集.html-81d14406.js" as="script"><link rel="prefetch" href="/assets/栈和队列.html-fdee587b.js" as="script"><link rel="prefetch" href="/assets/树状数组和线段树.html-50a99469.js" as="script"><link rel="prefetch" href="/assets/图相关的基本算法.html-45524102.js" as="script"><link rel="prefetch" href="/assets/树、图的存储和遍历.html-c9c461ed.js" as="script"><link rel="prefetch" href="/assets/DesignPattern.html-ad290a7e.js" as="script"><link rel="prefetch" href="/assets/builder.html-cd91d61c.js" as="script"><link rel="prefetch" href="/assets/chain.html-cb0459b3.js" as="script"><link rel="prefetch" href="/assets/strategy.html-8bd3ed4f.js" as="script"><link rel="prefetch" href="/assets/golang-plugin.html-5452c2fe.js" as="script"><link rel="prefetch" href="/assets/golang基础入门.html-58b3eb63.js" as="script"><link rel="prefetch" href="/assets/index.html-a48563f0.js" as="script"><link rel="prefetch" href="/assets/SPI.html-09d4bacf.js" as="script"><link rel="prefetch" href="/assets/jvm.html-c41a905a.js" as="script"><link rel="prefetch" href="/assets/ruoyi-vue启动配置.html-ea334c21.js" as="script"><link rel="prefetch" href="/assets/redis使用场景.html-bd17fc76.js" as="script"><link rel="prefetch" href="/assets/redis持久化.html-c9f95200.js" as="script"><link rel="prefetch" href="/assets/rust入门01-基础配置.html-f14caf72.js" as="script"><link rel="prefetch" href="/assets/springboot发布订阅机制.html-5493ce14.js" as="script"><link rel="prefetch" href="/assets/动手写starter.html-3798cc84.js" as="script"><link rel="prefetch" href="/assets/自定义spring-cloud-gateway-filter.html-79fe2e7f.js" as="script"><link rel="prefetch" href="/assets/非spring管理的类使用bean.html-4756608b.js" as="script"><link rel="prefetch" href="/assets/C编程杂记.html-af9b9a1d.js" as="script"><link rel="prefetch" href="/assets/Makefile.html-5b661539.js" as="script"><link rel="prefetch" href="/assets/risc-v.html-1fa0a9d6.js" as="script"><link rel="prefetch" href="/assets/computer-summary.html-15fdce20.js" as="script"><link rel="prefetch" href="/assets/system-bus.html-79150efb.js" as="script"><link rel="prefetch" href="/assets/汇编下的函数调用.html-ba2361f7.js" as="script"><link rel="prefetch" href="/assets/csapp-信息的表示和处理.html-bea84563.js" as="script"><link rel="prefetch" href="/assets/csapp-程序的机器级表示(1).html-7484a122.js" as="script"><link rel="prefetch" href="/assets/csapp-程序的机器级表示(2).html-eb2c994c.js" as="script"><link rel="prefetch" href="/assets/network-ttd-application.html-271c282f.js" as="script"><link rel="prefetch" href="/assets/network-ttd-summary.html-1b03357e.js" as="script"><link rel="prefetch" href="/assets/snmp-Java.html-cdbffdaa.js" as="script"><link rel="prefetch" href="/assets/snmp压力测试.html-c01bd76c.js" as="script"><link rel="prefetch" href="/assets/ostep-concurrency.html-7d636c94.js" as="script"><link rel="prefetch" href="/assets/ostep-persistence.html-ad5d2ed5.js" as="script"><link rel="prefetch" href="/assets/ostep-virtualization-cpu.html-b0003fe4.js" as="script"><link rel="prefetch" href="/assets/ostep-virtualization-memory.html-45ac2b89.js" as="script"><link rel="prefetch" href="/assets/CPU缓存一致性.html-27640a99.js" as="script"><link rel="prefetch" href="/assets/关于提问.html-4b09e8d8.js" as="script"><link rel="prefetch" href="/assets/Backup-VMware.html-a4c90ba2.js" as="script"><link rel="prefetch" href="/assets/Frangipani.html-3c2a116d.js" as="script"><link rel="prefetch" href="/assets/GFS.html-1d395bd2.js" as="script"><link rel="prefetch" href="/assets/Introduction-MapReduce.html-4d67b644.js" as="script"><link rel="prefetch" href="/assets/index.html-4a4fc4a1.js" as="script"><link rel="prefetch" href="/assets/Spanner.html-8c307be5.js" as="script"><link rel="prefetch" href="/assets/Zookeeper.html-088641ab.js" as="script"><link rel="prefetch" href="/assets/分布式事务.html-a5ce5ca6.js" as="script"><link rel="prefetch" href="/assets/链式复制.html-e4612b8d.js" as="script"><link rel="prefetch" href="/assets/Angular基础入门.html-c4760f33.js" as="script"><link rel="prefetch" href="/assets/Angular环境配置和基础认知.html-71fceb7a.js" as="script"><link rel="prefetch" href="/assets/ES6-01 let和const.html-4974fa52.js" as="script"><link rel="prefetch" href="/assets/ES6-02 解构赋值.html-c40bc963.js" as="script"><link rel="prefetch" href="/assets/ES6-03 class.html-282a0081.js" as="script"><link rel="prefetch" href="/assets/ES6-04 ES6新增用法.html-ccffdc43.js" as="script"><link rel="prefetch" href="/assets/ES6-05 Symbol.html-2b30945f.js" as="script"><link rel="prefetch" href="/assets/ES6-06 Module的导入和导出.html-376668d4.js" as="script"><link rel="prefetch" href="/assets/最长系列.html-4acc5e07.js" as="script"><link rel="prefetch" href="/assets/反转链表.html-3c5d4787.js" as="script"><link rel="prefetch" href="/assets/合并链表.html-22e7414b.js" as="script"><link rel="prefetch" href="/assets/数的二次方根.html-6c8f3083.js" as="script"><link rel="prefetch" href="/assets/组合.html-055d36a8.js" as="script"><link rel="prefetch" href="/assets/ebpf杂记.html-3442c502.js" as="script"><link rel="prefetch" href="/assets/支付服务.html-de1c5180.js" as="script"><link rel="prefetch" href="/assets/用户服务.html-2d79f898.js" as="script"><link rel="prefetch" href="/assets/订单服务.html-adebf0ec.js" as="script"><link rel="prefetch" href="/assets/Redis.html-5fb3c285.js" as="script"><link rel="prefetch" href="/assets/RocketMq.html-2fb8ca8d.js" as="script"><link rel="prefetch" href="/assets/go-zero入门实践.html-946e17c3.js" as="script"><link rel="prefetch" href="/assets/Basic.html-255d7873.js" as="script"><link rel="prefetch" href="/assets/Collction.html-75d6ab2a.js" as="script"><link rel="prefetch" href="/assets/JDK动态代理.html-e70757de.js" as="script"><link rel="prefetch" href="/assets/ThreadLocal.html-5eef6bcc.js" as="script"><link rel="prefetch" href="/assets/enum.html-0a176866.js" as="script"><link rel="prefetch" href="/assets/this与super.html-71ee4784.js" as="script"><link rel="prefetch" href="/assets/方法调用.html-22c9acd5.js" as="script"><link rel="prefetch" href="/assets/泛型.html-df3f4983.js" as="script"><link rel="prefetch" href="/assets/juc.html-526b1ba3.js" as="script"><link rel="prefetch" href="/assets/快速消费线程池.html-0b35653f.js" as="script"><link rel="prefetch" href="/assets/summary-question.html-63b87c73.js" as="script"><link rel="prefetch" href="/assets/MapReduce.html-9c871870.js" as="script"><link rel="prefetch" href="/assets/404.html-4f169f81.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-32c63708.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">zzys</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/interview/" class="" aria-label="interview"><!--[--><!--]--> interview <!--[--><!--]--></a></div><div class="navbar-item"><a href="/code/" class="" aria-label="code"><!--[--><!--]--> code <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/YangZhang-dev" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/interview/" class="" aria-label="interview"><!--[--><!--]--> interview <!--[--><!--]--></a></div><div class="navbar-item"><a href="/code/" class="" aria-label="code"><!--[--><!--]--> code <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/YangZhang-dev" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">code <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">algorithm <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">dp <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/algorithm/dp/DP.html" class="sidebar-item" aria-label="DP问题"><!--[--><!--]--> DP问题 <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/dp/%E7%BA%BF%E6%80%A7DP.html" class="sidebar-item" aria-label="线性DP"><!--[--><!--]--> 线性DP <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/dp/%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98.html" class="sidebar-item" aria-label="背包问题"><!--[--><!--]--> 背包问题 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">排序 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/algorithm/%E6%8E%92%E5%BA%8F/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F.html" class="sidebar-item" aria-label="归并排序"><!--[--><!--]--> 归并排序 <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/%E6%8E%92%E5%BA%8F/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F.html" class="sidebar-item" aria-label="快速排序"><!--[--><!--]--> 快速排序 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">数据结构 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/algorithm/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%8D%95%E9%93%BE%E8%A1%A8%E5%92%8C%E5%8F%8C%E9%93%BE%E8%A1%A8%E7%9A%84%E6%95%B0%E7%BB%84%E5%AE%9E%E7%8E%B0.html" class="sidebar-item" aria-label="单链表和双链表的数组实现"><!--[--><!--]--> 单链表和双链表的数组实现 <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%B9%B6%E6%9F%A5%E9%9B%86.html" class="sidebar-item" aria-label="并查集"><!--[--><!--]--> 并查集 <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%88%E5%92%8C%E9%98%9F%E5%88%97.html" class="sidebar-item" aria-label="栈和队列"><!--[--><!--]--> 栈和队列 <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84%E5%92%8C%E7%BA%BF%E6%AE%B5%E6%A0%91.html" class="sidebar-item" aria-label="树状数组和线段树"><!--[--><!--]--> 树状数组和线段树 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">树图 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/algorithm/%E6%A0%91%E5%9B%BE/%E5%9B%BE%E7%9B%B8%E5%85%B3%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%AE%97%E6%B3%95.html" class="sidebar-item" aria-label="图相关的基本算法"><!--[--><!--]--> 图相关的基本算法 <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/%E6%A0%91%E5%9B%BE/%E6%A0%91%E3%80%81%E5%9B%BE%E7%9A%84%E5%AD%98%E5%82%A8%E5%92%8C%E9%81%8D%E5%8E%86.html" class="sidebar-item" aria-label="树和图的存储及遍历"><!--[--><!--]--> 树和图的存储及遍历 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/code/algorithm/DFS%E3%80%81BFS.html" class="sidebar-item" aria-label="DFS、BFS"><!--[--><!--]--> DFS、BFS <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/KMP%E3%80%81Trie.html" class="sidebar-item" aria-label="KMP、Trie"><!--[--><!--]--> KMP、Trie <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/%E4%BA%8C%E5%88%86%E9%97%AE%E9%A2%98.html" class="sidebar-item" aria-label="二分"><!--[--><!--]--> 二分 <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/%E4%BD%8D%E8%BF%90%E7%AE%97%E3%80%81%E7%A6%BB%E6%95%A3%E5%8C%96%E3%80%81%E5%8C%BA%E9%97%B4%E5%90%88%E5%B9%B6.html" class="sidebar-item" aria-label="位运算、离散化、区间合并"><!--[--><!--]--> 位运算、离散化、区间合并 <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/%E5%89%8D%E7%BC%80%E5%92%8C.html" class="sidebar-item" aria-label="前缀和"><!--[--><!--]--> 前缀和 <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/%E5%8F%8C%E6%8C%87%E9%92%88.html" class="sidebar-item" aria-label="双指针"><!--[--><!--]--> 双指针 <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/%E5%A0%86%E3%80%81%E5%93%88%E5%B8%8C.html" class="sidebar-item" aria-label="堆和哈希"><!--[--><!--]--> 堆和哈希 <!--[--><!--]--></a><!----></li><li><a href="/code/algorithm/%E5%B7%AE%E5%88%86.html" class="sidebar-item" aria-label="差分"><!--[--><!--]--> 差分 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">back <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">designpattern <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/back/designpattern/DesignPattern.html" class="sidebar-item" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a><!----></li><li><a href="/code/back/designpattern/builder.html" class="sidebar-item" aria-label="builder"><!--[--><!--]--> builder <!--[--><!--]--></a><!----></li><li><a href="/code/back/designpattern/chain.html" class="sidebar-item" aria-label="builder"><!--[--><!--]--> builder <!--[--><!--]--></a><!----></li><li><a href="/code/back/designpattern/strategy.html" class="sidebar-item" aria-label="strategy"><!--[--><!--]--> strategy <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">go <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">go-zero <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/back/go/go-zero/go-zero%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5.html" class="sidebar-item" aria-label="go-zero的入门实践"><!--[--><!--]--> go-zero的入门实践 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/code/back/go/golang-plugin.html" class="sidebar-item" aria-label="golang-plugin"><!--[--><!--]--> golang-plugin <!--[--><!--]--></a><!----></li><li><a href="/code/back/go/golang%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8.html" class="sidebar-item" aria-label="golang基础入门"><!--[--><!--]--> golang基础入门 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">mq <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">rocketmq <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/back/mq/rocketmq/summary-question.html" class="sidebar-item" aria-label="summary-question"><!--[--><!--]--> summary-question <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">redis <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/back/redis/redis%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF.html" class="sidebar-item" aria-label="redis使用场景"><!--[--><!--]--> redis使用场景 <!--[--><!--]--></a><!----></li><li><a href="/code/back/redis/redis%E6%8C%81%E4%B9%85%E5%8C%96.html" class="sidebar-item" aria-label="redis持久化"><!--[--><!--]--> redis持久化 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">rust <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/back/rust/rust%E5%85%A5%E9%97%A801-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE.html" class="sidebar-item" aria-label="rust入门01-基础配置"><!--[--><!--]--> rust入门01-基础配置 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">spring <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/back/spring/%E5%8A%A8%E6%89%8B%E5%86%99starter.html" class="sidebar-item" aria-label="动手写starter"><!--[--><!--]--> 动手写starter <!--[--><!--]--></a><!----></li><li><a href="/code/back/spring/%E9%9D%9Espring%E7%AE%A1%E7%90%86%E7%9A%84%E7%B1%BB%E4%BD%BF%E7%94%A8bean.html" class="sidebar-item" aria-label="非spring管理的类使用bean"><!--[--><!--]--> 非spring管理的类使用bean <!--[--><!--]--></a><!----></li><li><a href="/code/back/spring/%E8%87%AA%E5%AE%9A%E4%B9%89spring-cloud-gateway-filter.html" class="sidebar-item" aria-label="自定义spring-cloud-gateway-filter"><!--[--><!--]--> 自定义spring-cloud-gateway-filter <!--[--><!--]--></a><!----></li><li><a href="/code/back/spring/springboot%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%9C%BA%E5%88%B6.html" class="sidebar-item" aria-label="springboot发布订阅机制"><!--[--><!--]--> springboot发布订阅机制 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">basic <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">C <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/basic/C/C%E7%BC%96%E7%A8%8B%E6%9D%82%E8%AE%B0.html" class="sidebar-item" aria-label="C编程杂记"><!--[--><!--]--> C编程杂记 <!--[--><!--]--></a><!----></li><li><a href="/code/basic/C/Makefile.html" class="sidebar-item" aria-label="Makefile"><!--[--><!--]--> Makefile <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">arch <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/basic/arch/risc-v.html" class="sidebar-item" aria-label="risc-v"><!--[--><!--]--> risc-v <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">computer-organization <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/basic/computer-organization/computer-summary.html" class="sidebar-item" aria-label="computer-summary"><!--[--><!--]--> computer-summary <!--[--><!--]--></a><!----></li><li><a href="/code/basic/computer-organization/system-bus.html" class="sidebar-item" aria-label="system-bus"><!--[--><!--]--> system-bus <!--[--><!--]--></a><!----></li><li><a href="/code/basic/computer-organization/%E6%B1%87%E7%BC%96%E4%B8%8B%E7%9A%84%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8.html" class="sidebar-item" aria-label="汇编下的函数调用"><!--[--><!--]--> 汇编下的函数调用 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">csapp <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/basic/csapp/csapp-%E4%BF%A1%E6%81%AF%E7%9A%84%E8%A1%A8%E7%A4%BA%E5%92%8C%E5%A4%84%E7%90%86.html" class="sidebar-item" aria-label="csapp-信息的表示和处理"><!--[--><!--]--> csapp-信息的表示和处理 <!--[--><!--]--></a><!----></li><li><a href="/code/basic/csapp/csapp-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA(1).html" class="sidebar-item" aria-label="csapp-程序的机器级表示(1)"><!--[--><!--]--> csapp-程序的机器级表示(1) <!--[--><!--]--></a><!----></li><li><a href="/code/basic/csapp/csapp-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA(2).html" class="sidebar-item" aria-label="csapp-程序的机器级表示(2)"><!--[--><!--]--> csapp-程序的机器级表示(2) <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">network <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/basic/network/network-ttd-application.html" class="sidebar-item" aria-label="network-ttd-application"><!--[--><!--]--> network-ttd-application <!--[--><!--]--></a><!----></li><li><a href="/code/basic/network/network-ttd-summary.html" class="sidebar-item" aria-label="network-ttd-summary"><!--[--><!--]--> network-ttd-summary <!--[--><!--]--></a><!----></li><li><a href="/code/basic/network/snmp-Java.html" class="sidebar-item" aria-label="snmp-Java"><!--[--><!--]--> snmp-Java <!--[--><!--]--></a><!----></li><li><a href="/code/basic/network/snmp%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95.html" class="sidebar-item" aria-label="snmp压力测试"><!--[--><!--]--> snmp压力测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">ostep <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/basic/ostep/ostep-virtualization-cpu.html" class="sidebar-item" aria-label="ostep-virtualization-cpu"><!--[--><!--]--> ostep-virtualization-cpu <!--[--><!--]--></a><!----></li><li><a href="/code/basic/ostep/ostep-virtualization-memory.html" class="sidebar-item" aria-label="ostep-virtualization-memory"><!--[--><!--]--> ostep-virtualization-memory <!--[--><!--]--></a><!----></li><li><a href="/code/basic/ostep/ostep-concurrency.html" class="sidebar-item" aria-label="ostep-concurrency"><!--[--><!--]--> ostep-concurrency <!--[--><!--]--></a><!----></li><li><a href="/code/basic/ostep/ostep-persistence.html" class="sidebar-item" aria-label="ostep-persistence"><!--[--><!--]--> ostep-persistence <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">sundry <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/basic/sundry/CPU%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7.html" class="sidebar-item" aria-label="CPU缓存一致性"><!--[--><!--]--> CPU缓存一致性 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">ysyx <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/basic/ysyx/%E5%85%B3%E4%BA%8E%E6%8F%90%E9%97%AE.html" class="sidebar-item" aria-label="关于提问"><!--[--><!--]--> 关于提问 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">distribute <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">mit-6.824 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">lab <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/distribute/mit-6.824/lab/MapReduce.html" class="sidebar-item" aria-label="MapReduce"><!--[--><!--]--> MapReduce <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/code/distribute/mit-6.824/Introduction-MapReduce.html" class="sidebar-item" aria-label="Introduction-MapReduce"><!--[--><!--]--> Introduction-MapReduce <!--[--><!--]--></a><!----></li><li><a href="/code/distribute/mit-6.824/GFS.html" class="sidebar-item" aria-label="GFS"><!--[--><!--]--> GFS <!--[--><!--]--></a><!----></li><li><a href="/code/distribute/mit-6.824/Backup-VMware.html" class="sidebar-item" aria-label="Backup-VMware"><!--[--><!--]--> Backup-VMware <!--[--><!--]--></a><!----></li><li><a href="/code/distribute/mit-6.824/Zookeeper.html" class="sidebar-item" aria-label="Zookeeper"><!--[--><!--]--> Zookeeper <!--[--><!--]--></a><!----></li><li><a href="/code/distribute/mit-6.824/%E9%93%BE%E5%BC%8F%E5%A4%8D%E5%88%B6.html" class="sidebar-item" aria-label="链式复制"><!--[--><!--]--> 链式复制 <!--[--><!--]--></a><!----></li><li><a href="/code/distribute/mit-6.824/Frangipani.html" class="sidebar-item" aria-label="Frangipani"><!--[--><!--]--> Frangipani <!--[--><!--]--></a><!----></li><li><a href="/code/distribute/mit-6.824/Spanner.html" class="sidebar-item" aria-label="Spanner"><!--[--><!--]--> Spanner <!--[--><!--]--></a><!----></li><li><a href="/code/distribute/mit-6.824/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.html" class="sidebar-item" aria-label="分布式事务"><!--[--><!--]--> 分布式事务 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">front <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">angular <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/front/angular/Angular%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%92%8C%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5.html" class="sidebar-item" aria-label="Angular环境配置和基础认知"><!--[--><!--]--> Angular环境配置和基础认知 <!--[--><!--]--></a><!----></li><li><a href="/code/front/angular/Angular%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8.html" class="sidebar-item" aria-label="Angular基础入门"><!--[--><!--]--> Angular基础入门 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">es6 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/front/es6/ES6-01%20let%E5%92%8Cconst.html" class="sidebar-item" aria-label="ES6-01 let&amp;const"><!--[--><!--]--> ES6-01 let&amp;const <!--[--><!--]--></a><!----></li><li><a href="/code/front/es6/ES6-02%20%E8%A7%A3%E6%9E%84%E8%B5%8B%E5%80%BC.html" class="sidebar-item" aria-label="ES6-02 解构赋值"><!--[--><!--]--> ES6-02 解构赋值 <!--[--><!--]--></a><!----></li><li><a href="/code/front/es6/ES6-03%20class.html" class="sidebar-item" aria-label="ES6-03 class"><!--[--><!--]--> ES6-03 class <!--[--><!--]--></a><!----></li><li><a href="/code/front/es6/ES6-04%20ES6%E6%96%B0%E5%A2%9E%E7%94%A8%E6%B3%95.html" class="sidebar-item" aria-label="ES6-04 ES6新增用法"><!--[--><!--]--> ES6-04 ES6新增用法 <!--[--><!--]--></a><!----></li><li><a href="/code/front/es6/ES6-05%20Symbol.html" class="sidebar-item" aria-label="ES6-05 Symbol"><!--[--><!--]--> ES6-05 Symbol <!--[--><!--]--></a><!----></li><li><a href="/code/front/es6/ES6-06%20Module%E7%9A%84%E5%AF%BC%E5%85%A5%E5%92%8C%E5%AF%BC%E5%87%BA.html" class="sidebar-item" aria-label="ES6-06 Module的导入和导出"><!--[--><!--]--> ES6-06 Module的导入和导出 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">leetcode <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">dp <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/leetcode/dp/%E6%9C%80%E9%95%BF%E7%B3%BB%E5%88%97.html" class="sidebar-item" aria-label="最长系列"><!--[--><!--]--> 最长系列 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">link <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/leetcode/link/%E5%8F%8D%E8%BD%AC%E9%93%BE%E8%A1%A8.html" class="sidebar-item" aria-label="反转链表"><!--[--><!--]--> 反转链表 <!--[--><!--]--></a><!----></li><li><a href="/code/leetcode/link/%E5%90%88%E5%B9%B6%E9%93%BE%E8%A1%A8.html" class="sidebar-item" aria-label="合并链表"><!--[--><!--]--> 合并链表 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">二分 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/leetcode/%E4%BA%8C%E5%88%86/%E6%95%B0%E7%9A%84%E4%BA%8C%E6%AC%A1%E6%96%B9%E6%A0%B9.html" class="sidebar-item" aria-label="数的二次方根"><!--[--><!--]--> 数的二次方根 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">回溯 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/leetcode/%E5%9B%9E%E6%BA%AF/%E7%BB%84%E5%90%88.html" class="sidebar-item" aria-label="组合"><!--[--><!--]--> 组合 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">linux <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">ebpf <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/linux/ebpf/ebpf%E6%9D%82%E8%AE%B0.html" class="sidebar-item" aria-label="ebpf杂记"><!--[--><!--]--> ebpf杂记 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/code/linux/kernel-user-buffer.html" class="sidebar-item" aria-label="kernel-user-buffer"><!--[--><!--]--> kernel-user-buffer <!--[--><!--]--></a><!----></li><li><a href="/code/linux/page-cache.html" class="sidebar-item" aria-label="page-cache"><!--[--><!--]--> page-cache <!--[--><!--]--></a><!----></li><li><a href="/code/linux/%E9%9B%B6%E6%8B%B7%E8%B4%9D.html" class="sidebar-item" aria-label="zero-cpoy"><!--[--><!--]--> zero-cpoy <!--[--><!--]--></a><!----></li><li><a href="/code/linux/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8.html" class="sidebar-item" aria-label="IO多路复用"><!--[--><!--]--> IO多路复用 <!--[--><!--]--></a><!----></li><li><a href="/code/linux/kernel-bypass.html" class="sidebar-item" aria-label="kernel-bypass"><!--[--><!--]--> kernel-bypass <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">mysql <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/mysql/InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E.html" class="sidebar-item" aria-label="存储引擎"><!--[--><!--]--> 存储引擎 <!--[--><!--]--></a><!----></li><li><a href="/code/mysql/%E4%BA%8B%E5%8A%A1.html" class="sidebar-item" aria-label="事务"><!--[--><!--]--> 事务 <!--[--><!--]--></a><!----></li><li><a href="/code/mysql/%E7%B4%A2%E5%BC%95.html" class="sidebar-item" aria-label="索引"><!--[--><!--]--> 索引 <!--[--><!--]--></a><!----></li><li><a href="/code/mysql/%E9%94%81.html" class="sidebar-item" aria-label="锁"><!--[--><!--]--> 锁 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">sundry <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/code/sundry/snowflakeid.html" class="sidebar-item" aria-label="snowflakeid"><!--[--><!--]--> snowflakeid <!--[--><!--]--></a><!----></li><li><a href="/code/sundry/%E5%B9%82%E7%AD%89.html" class="sidebar-item" aria-label="幂等"><!--[--><!--]--> 幂等 <!--[--><!--]--></a><!----></li><li><a href="/code/sundry/%E7%A7%92%E6%9D%80%E5%9C%BA%E6%99%AF.html" class="sidebar-item" aria-label="秒杀场景"><!--[--><!--]--> 秒杀场景 <!--[--><!--]--></a><!----></li><li><a href="/code/sundry/%E9%99%90%E6%B5%81.html" class="sidebar-item" aria-label="限流"><!--[--><!--]--> 限流 <!--[--><!--]--></a><!----></li><li><a href="/code/sundry/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81.html" class="sidebar-item" aria-label="分布式锁"><!--[--><!--]--> 分布式锁 <!--[--><!--]--></a><!----></li><li><a href="/code/sundry/%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4.html" class="sidebar-item" aria-label="两阶段提交"><!--[--><!--]--> 两阶段提交 <!--[--><!--]--></a><!----></li><li><a href="/code/sundry/COW-%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6.html" class="sidebar-item" aria-label="COW-写时复制"><!--[--><!--]--> COW-写时复制 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">interview <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item collapsible">pre <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/interview/pre/Java-%E5%96%9C%E9%A9%AC%E6%8B%89%E9%9B%85-%E5%AE%9E%E4%B9%A0-23-8-21.html" class="sidebar-item" aria-label="Java-喜马拉雅-实习生-23-8-21"><!--[--><!--]--> Java-喜马拉雅-实习生-23-8-21 <!--[--><!--]--></a><!----></li><li><a href="/interview/pre/Java-%E6%95%B0%E6%96%B0%E7%BD%91%E7%BB%9C-%E5%AE%9E%E4%B9%A0-23-12-07.html" class="sidebar-item" aria-label="Java-数新网络-实习-23-12-07"><!--[--><!--]--> Java-数新网络-实习-23-12-07 <!--[--><!--]--></a><!----></li><li><a href="/interview/pre/Golang-%E7%99%BE%E5%BA%A6-%E5%AE%9E%E4%B9%A0-23-12-11.html" class="sidebar-item" aria-label="Golang-百度-实习-23-12-11"><!--[--><!--]--> Golang-百度-实习-23-12-11 <!--[--><!--]--></a><!----></li><li><a href="/interview/pre/Golang-%E4%B8%87%E5%A3%B0%E9%9F%B3%E4%B9%90-%E5%AE%9E%E4%B9%A0-23-12-27.html" class="sidebar-item" aria-label="Golang-万声音乐-实习-23-12-27.md"><!--[--><!--]--> Golang-万声音乐-实习-23-12-27.md <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">wait <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/interview/wait/go.html" class="sidebar-item" aria-label="go面经"><!--[--><!--]--> go面经 <!--[--><!--]--></a><!----></li><li><a href="/interview/wait/java.html" class="sidebar-item" aria-label="java面经"><!--[--><!--]--> java面经 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/interview/JUC.html" class="sidebar-item" aria-label="JUC常见面试题"><!--[--><!--]--> JUC常见面试题 <!--[--><!--]--></a><!----></li><li><a href="/interview/Java.html" class="sidebar-item" aria-label="Java常见面试题"><!--[--><!--]--> Java常见面试题 <!--[--><!--]--></a><!----></li><li><a href="/interview/Redis.html" class="sidebar-item" aria-label="Redis面经"><!--[--><!--]--> Redis面经 <!--[--><!--]--></a><!----></li><li><a href="/interview/algorithm.html" class="sidebar-item" aria-label="算法和数据结构面经"><!--[--><!--]--> 算法和数据结构面经 <!--[--><!--]--></a><!----></li><li><a href="/interview/mysql.html" class="sidebar-item" aria-label="MySQL面试题总结"><!--[--><!--]--> MySQL面试题总结 <!--[--><!--]--></a><!----></li><li><a href="/interview/network.html" class="sidebar-item" aria-label="网络面经"><!--[--><!--]--> 网络面经 <!--[--><!--]--></a><!----></li><li><a href="/interview/spring.html" class="sidebar-item" aria-label="sprin常见面试题"><!--[--><!--]--> sprin常见面试题 <!--[--><!--]--></a><!----></li><li><a href="/interview/sundry.html" class="sidebar-item" aria-label="sundry"><!--[--><!--]--> sundry <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading active collapsible">project <span class="down arrow"></span></p><ul style="" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item active collapsible">12306 <span class="down arrow"></span></p><ul style="" class="sidebar-item-children"><!--[--><li><p tabindex="0" class="sidebar-item active collapsible">service <span class="down arrow"></span></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/project/12306/service/%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1.html" class="sidebar-item" aria-label="用户服务"><!--[--><!--]--> 用户服务 <!--[--><!--]--></a><!----></li><li><a href="/project/12306/service/%E6%94%AF%E4%BB%98%E6%9C%8D%E5%8A%A1.html" class="sidebar-item" aria-label="支付服务"><!--[--><!--]--> 支付服务 <!--[--><!--]--></a><!----></li><li><a href="/project/12306/service/%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1.html" class="sidebar-item" aria-label="订单服务"><!--[--><!--]--> 订单服务 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="票务服务"><!--[--><!--]--> 票务服务 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html#余票查询的特点" class="router-link-active router-link-exact-active sidebar-item" aria-label="余票查询的特点"><!--[--><!--]--> 余票查询的特点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html#余票查询" class="router-link-active router-link-exact-active sidebar-item" aria-label="余票查询"><!--[--><!--]--> 余票查询 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html#购票的特点" class="router-link-active router-link-exact-active sidebar-item" aria-label="购票的特点"><!--[--><!--]--> 购票的特点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html#购票策略" class="router-link-active router-link-exact-active sidebar-item" aria-label="购票策略"><!--[--><!--]--> 购票策略 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html#购票" class="router-link-active router-link-exact-active sidebar-item" aria-label="购票"><!--[--><!--]--> 购票 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html#controller" class="router-link-active router-link-exact-active sidebar-item" aria-label="Controller"><!--[--><!--]--> Controller <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html#责任链" class="router-link-active router-link-exact-active sidebar-item" aria-label="责任链"><!--[--><!--]--> 责任链 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html#v1" class="router-link-active router-link-exact-active sidebar-item" aria-label="V1"><!--[--><!--]--> V1 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html#v2" class="router-link-active router-link-exact-active sidebar-item" aria-label="V2"><!--[--><!--]--> V2 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html#购票流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="购票流程"><!--[--><!--]--> 购票流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/project/12306/service/%E7%A5%A8%E5%8A%A1%E6%9C%8D%E5%8A%A1.html#trainseattypeselector" class="router-link-active router-link-exact-active sidebar-item" aria-label="TrainSeatTypeSelector"><!--[--><!--]--> TrainSeatTypeSelector <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">中间件 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/project/12306/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis.html" class="sidebar-item" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a><!----></li><li><a href="/project/12306/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMq.html" class="sidebar-item" aria-label="RocketMQ"><!--[--><!--]--> RocketMQ <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/project/12306/%E9%A1%B9%E7%9B%AE%E5%87%86%E5%A4%87.html" class="sidebar-item" aria-label="项目准备"><!--[--><!--]--> 项目准备 <!--[--><!--]--></a><!----></li><li><a href="/project/12306/%E7%BB%84%E4%BB%B6%E5%BC%80%E5%8F%91.html" class="sidebar-item" aria-label="组件开发"><!--[--><!--]--> 组件开发 <!--[--><!--]--></a><!----></li><li><a href="/project/12306/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1.html" class="sidebar-item" aria-label="数据库表设计"><!--[--><!--]--> 数据库表设计 <!--[--><!--]--></a><!----></li><li><a href="/project/12306/%E6%B5%8B%E8%AF%95.html" class="sidebar-item" aria-label="测试"><!--[--><!--]--> 测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">summer-framework <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/project/summer-framework/IOC.html" class="sidebar-item" aria-label="IOC"><!--[--><!--]--> IOC <!--[--><!--]--></a><!----></li><li><a href="/project/summer-framework/AOP.html" class="sidebar-item" aria-label="AOP"><!--[--><!--]--> AOP <!--[--><!--]--></a><!----></li><li><a href="/project/summer-framework/JdbcTemplate-Transaction.html" class="sidebar-item" aria-label="JdbcTemplate-Transaction"><!--[--><!--]--> JdbcTemplate-Transaction <!--[--><!--]--></a><!----></li><li><a href="/project/summer-framework/MVC.html" class="sidebar-item" aria-label="MVC"><!--[--><!--]--> MVC <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">template <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/template/markdown.html" class="sidebar-item" aria-label="markdown的使用"><!--[--><!--]--> markdown的使用 <!--[--><!--]--></a><!----></li><li><a href="/template/mermaid%E4%BD%BF%E7%94%A8.html" class="sidebar-item" aria-label="mermaid使用"><!--[--><!--]--> mermaid使用 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">think <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/think/how-to-learn.html" class="sidebar-item" aria-label="how-to-learn"><!--[--><!--]--> how-to-learn <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><p>票务服务是整个项目的核心，它承接着其他三个接口。其中最重要的就是余票查询和买票以及订单的取消。</p><h2 id="余票查询的特点" tabindex="-1"><a class="header-anchor" href="#余票查询的特点" aria-hidden="true">#</a> 余票查询的特点</h2><p>必须选择<strong>起始地点</strong>和<strong>到达地点</strong>（城市或站点），必须选择一个<strong>时间</strong>（天）</p><p>只有点击查询时，才会携带着起始地点、到达地点、日期发送请求进行查询。</p><p>而对于非必选条件，实际上是在前端进行筛选，因为我们知道，列车的数据量是不大的，每次都在后端筛选也不太好，十分占用性能，不如全部都发送给前端，由前端进行筛选。</p><p>实际上非必选条件也是根据返回的列车数据中存在的特征分类聚集的。</p><h2 id="余票查询" tabindex="-1"><a class="header-anchor" href="#余票查询" aria-hidden="true">#</a> 余票查询</h2><p>首先要经过一条责任链，我们先对其进行讲解。</p><p>首先是参数的校验：参数不能为空、参数的合法：起始时间不能晚于到达时间，出发地和目的地不能相同。</p><p>然后是判断出发地和目的地是否存在，其中我们需要访问redis中的一个Hash结构，里面存放了所有的城市和站点。如下：</p><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/e1e4aff8dced7ba00e89dc9ddd003099.png" alt="" loading="lazy"></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 数据加载标识</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> <span class="token constant">CACHE_DATA_ISNULL_AND_LOAD_FLAG</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">TicketPageQueryReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">)</span> distributedCache<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> hashOperations <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//  从redis中拿到所有的起始和终点</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> actualExistList <span class="token operator">=</span> hashOperations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span>
                <span class="token constant">QUERY_ALL_REGION_LIST</span><span class="token punctuation">,</span>
                <span class="token class-name">ListUtil</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> emptyCount <span class="token operator">=</span> actualExistList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">isNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果两个都存在，直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyCount <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果只有一个不存在或者</span>
        <span class="token comment">// 有两个不存在并且缓存数据已经被加载过并且key存在</span>
        <span class="token comment">//  说明站点不存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyCount <span class="token operator">==</span> <span class="token number">1L</span> <span class="token operator">||</span> <span class="token punctuation">(</span>emptyCount <span class="token operator">==</span> <span class="token number">2L</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">CACHE_DATA_ISNULL_AND_LOAD_FLAG</span> <span class="token operator">&amp;&amp;</span> distributedCache<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token constant">QUERY_ALL_REGION_LIST</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">&quot;出发地或目的地不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果说新增了站点，则需要将redis中的QUERY_ALL_REGION_LIST删除</span>
        
        <span class="token comment">// 如果有两个不存在并且(缓存数据已经被加载过或key存在)</span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_QUERY_ALL_REGION_LIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 双重判定锁去加载数据</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>distributedCache<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token constant">QUERY_ALL_REGION_LIST</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                actualExistList <span class="token operator">=</span> hashOperations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span>
                        <span class="token constant">QUERY_ALL_REGION_LIST</span><span class="token punctuation">,</span>
                        <span class="token class-name">ListUtil</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                emptyCount <span class="token operator">=</span> actualExistList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyCount <span class="token operator">!=</span> <span class="token number">2L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">&quot;出发地或目的地不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RegionDO</span><span class="token punctuation">&gt;</span></span> regionDOList <span class="token operator">=</span> regionMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">emptyWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StationDO</span><span class="token punctuation">&gt;</span></span> stationDOList <span class="token operator">=</span> stationMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">emptyWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> regionValueMap <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RegionDO</span> each <span class="token operator">:</span> regionDOList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                regionValueMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StationDO</span> each <span class="token operator">:</span> stationDOList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                regionValueMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            hashOperations<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token constant">QUERY_ALL_REGION_LIST</span><span class="token punctuation">,</span> regionValueMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token constant">CACHE_DATA_ISNULL_AND_LOAD_FLAG</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// 从数据库中的数据进行判断</span>
            emptyCount <span class="token operator">=</span> regionValueMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>each <span class="token operator">-&gt;</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equalsAny</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyCount <span class="token operator">!=</span> <span class="token number">2L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">&quot;出发地或目的地不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着就是具体的查询业务逻辑。</p><p>如上文所诉，我们的查询参数最主要的就是起始地点，到达地点，以及时间（北京，杭州东）。</p><ol><li><p>由于传过来的是站点或城市的Code，所以我们首先通过redis将code转换为中文名称，注意code可能是城市也可能是站点，但最终都要<strong>映射</strong>到城市的中文名称。为了防止缓存穿透，采用分布式锁和双重判定锁来进行第一次加载。</p><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/2f6ae54ea3a4fe8bf3495e307e867bec.png" alt="" loading="lazy"></p></li><li><p>然后获取所有在这两个地点之间的车次<strong>详细信息</strong>，从redis中获取，同样使用分布式锁和双重判定锁防止缓存穿透。</p><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/b32d3021bbd8935622b3e19eb4c4ac07.png" alt="" loading="lazy"></p></li><li><p>对每一个车次，根据列车id，起始站点，到达站点获取座位价格信息（是一个List，因为一个列车由很多类型的座位）</p><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/91e9e6d777b0e40ede7ae04ca0196857.png" alt="" loading="lazy"></p></li><li><p>由上一步骤，对于每个座位，计算其余票情况，redis是hash，hashKey是列车id，起始站点，到达站点。k是座位类型，v是数量。如果数量是空则要调用seatMarginCacheLoader组件从数据库中进行加载计算。</p><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/32ece7cfea092096f407e768ac68b771.png" alt="" loading="lazy"></p></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">TicketPageQueryRespDTO</span> <span class="token function">pageListTicketQueryV1</span><span class="token punctuation">(</span><span class="token class-name">TicketPageQueryReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 责任链模式 验证城市名称是否存在、不存在加载缓存以及出发日期不能小于当前日期等等</span>
    ticketPageQueryAbstractChainContext<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">TicketChainMarkEnum</span><span class="token punctuation">.</span><span class="token constant">TRAIN_QUERY_FILTER</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">)</span> distributedCache<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1. </span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> stationDetails <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span><span class="token constant">REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">,</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> count <span class="token operator">=</span> stationDetails<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">isNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            stationDetails <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span><span class="token constant">REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">,</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            count <span class="token operator">=</span> stationDetails<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">isNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> regionTrainStationMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stationMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">emptyWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>each <span class="token operator">-&gt;</span> regionTrainStationMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getRegionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token constant">REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">,</span> regionTrainStationMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                stationDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stationDetails<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>regionTrainStationMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stationDetails<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>regionTrainStationMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2. </span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TicketListDTO</span><span class="token punctuation">&gt;</span></span> seatResults <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> buildRegionTrainStationHashKey <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token constant">REGION_TRAIN_STATION</span><span class="token punctuation">,</span> stationDetails<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stationDetails<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> regionTrainStationAllMap <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>buildRegionTrainStationHashKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>regionTrainStationAllMap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_REGION_TRAIN_STATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            regionTrainStationAllMap <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>buildRegionTrainStationHashKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>regionTrainStationAllMap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TrainStationRelationDO</span><span class="token punctuation">&gt;</span></span> trainStationRelationList <span class="token operator">=</span> trainStationRelationMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TrainStationRelationDO</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                                                                              <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TrainStationRelationDO</span><span class="token operator">::</span><span class="token function">getStartRegion</span><span class="token punctuation">,</span> stationDetails<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                                                                                              <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TrainStationRelationDO</span><span class="token operator">::</span><span class="token function">getEndRegion</span><span class="token punctuation">,</span> stationDetails<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TrainStationRelationDO</span> each <span class="token operator">:</span> trainStationRelationList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TrainDO</span> trainDO <span class="token operator">=</span> distributedCache<span class="token punctuation">.</span><span class="token function">safeGet</span><span class="token punctuation">(</span>
                        <span class="token constant">TRAIN_INFO</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">TrainDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> trainMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token constant">ADVANCE_TICKET_DAY</span><span class="token punctuation">,</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">TicketListDTO</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TicketListDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setTrainId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setTrainNumber</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getTrainNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setDepartureTime</span><span class="token punctuation">(</span><span class="token function">convertDateToLocalTime</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDepartureTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;HH:mm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setArrivalTime</span><span class="token punctuation">(</span><span class="token function">convertDateToLocalTime</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getArrivalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;HH:mm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setDuration</span><span class="token punctuation">(</span><span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">calculateHourDifference</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDepartureTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getArrivalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setDeparture</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setArrival</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setDepartureFlag</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDepartureFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setArrivalFlag</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getArrivalFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setTrainType</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getTrainType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setTrainBrand</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getTrainBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getTrainTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        result<span class="token punctuation">.</span><span class="token function">setTrainTags</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getTrainTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">long</span> betweenDay <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>date<span class="token punctuation">.</span></span>DateUtil</span><span class="token punctuation">.</span><span class="token function">betweenDay</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDepartureTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getArrivalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setDaysArrived</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> betweenDay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setSaleStatus</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getSaleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">setSaleTime</span><span class="token punctuation">(</span><span class="token function">convertDateToLocalTime</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getSaleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;MM-dd HH:mm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    seatResults<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    regionTrainStationAllMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheUtil</span><span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>buildRegionTrainStationHashKey<span class="token punctuation">,</span> regionTrainStationAllMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    seatResults <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span>
        <span class="token operator">?</span> regionTrainStationAllMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TicketListDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> seatResults<span class="token punctuation">;</span>
    seatResults <span class="token operator">=</span> seatResults<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimeStringComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TicketListDTO</span> each <span class="token operator">:</span> seatResults<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3. </span>
        <span class="token comment">// 获取指定列车、出发站点、到达站点的所有类型座位的价格</span>
        <span class="token class-name">String</span> trainStationPriceStr <span class="token operator">=</span> distributedCache<span class="token punctuation">.</span><span class="token function">safeGet</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token constant">TRAIN_STATION_PRICE</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TrainStationPriceDO</span><span class="token punctuation">&gt;</span></span> trainStationPriceQueryWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token class-name">TrainStationPriceDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TrainStationPriceDO</span><span class="token operator">::</span><span class="token function">getDeparture</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TrainStationPriceDO</span><span class="token operator">::</span><span class="token function">getArrival</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TrainStationPriceDO</span><span class="token operator">::</span><span class="token function">getTrainId</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>trainStationPriceMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>trainStationPriceQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token constant">ADVANCE_TICKET_DAY</span><span class="token punctuation">,</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TrainStationPriceDO</span><span class="token punctuation">&gt;</span></span> trainStationPriceDOList <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>trainStationPriceStr<span class="token punctuation">,</span> <span class="token class-name">TrainStationPriceDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeatClassDTO</span><span class="token punctuation">&gt;</span></span> seatClassList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 4. </span>
        trainStationPriceDOList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> seatType <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSeatType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> keySuffix <span class="token operator">=</span> <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> quantityObj <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">TRAIN_STATION_REMAINING_TICKET</span> <span class="token operator">+</span> keySuffix<span class="token punctuation">,</span> seatType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> quantity <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>quantityObj<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token operator">::</span><span class="token function">toString</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">parseInt</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElseGet</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> seatMarginMap <span class="token operator">=</span> seatMarginCacheLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seatType<span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>seatMarginMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSeatType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">parseInt</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            seatClassList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SeatClassDTO</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSeatType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantity<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        each<span class="token punctuation">.</span><span class="token function">setSeatClassList</span><span class="token punctuation">(</span>seatClassList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">TicketPageQueryRespDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">trainList</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">departureStationList</span><span class="token punctuation">(</span><span class="token function">buildDepartureStationList</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">arrivalStationList</span><span class="token punctuation">(</span><span class="token function">buildArrivalStationList</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">trainBrandList</span><span class="token punctuation">(</span><span class="token function">buildTrainBrandList</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">seatClassTypeList</span><span class="token punctuation">(</span><span class="token function">buildSeatClassList</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="购票的特点" tabindex="-1"><a class="header-anchor" href="#购票的特点" aria-hidden="true">#</a> 购票的特点</h2><p>购票相对于其他的购物还是有不同的，主要特点如下：</p><p>首先可以支持一个用户为其他尚未注册的乘车人购票，一个订单中会存在多个子订单。</p><p>其次是在这一个订单中，所有的子订单除了<strong>座位类型</strong>和<strong>车厢</strong>有可能不同外（实际上在项目中，一个车厢中的座位类型都是相同的，可以根据车厢判断座位类型），其余的应该都相同（同一天，同一趟列车，同一起点和终点）。</p><p>购票实际上分为两部分，提交订单和付款。提交订单10分钟如果没有付款，订单会自动关闭。在这十分钟内，该座位是处于锁定状态（对查询来说是已售出，如果订单关闭就会将状态改回未售出状态）</p><h2 id="购票策略" tabindex="-1"><a class="header-anchor" href="#购票策略" aria-hidden="true">#</a> 购票策略</h2><p>购票是存在一定的策略的，我们知道12306存在选座服务，如果可以，12306会优先帮助我们选择我们指定的座位，但是如果不满足就会<strong>自动分配</strong>席位。下面就讲解一下在项目中的自动分配策略。</p><p>订单中可以包含不同座位类型的子订单，我们下面的自动分配策略就针对一种座位类型来讲解，如果存在多种座位类型也是类似的。</p><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/fb8bee46b6aaf351341275251f99500f.png" alt="image-20231218122003303" loading="lazy"></p><p>对于多人购票，我们查找的条件是：相邻座位，相同车厢。如果无法满足相邻座位，则设法满足相同车厢，如果无法满足相同车厢，那么就随机分配。</p><h2 id="购票" tabindex="-1"><a class="header-anchor" href="#购票" aria-hidden="true">#</a> 购票</h2><p>购票存在两个接口，V2对V1的<strong>互斥逻辑</strong>进行了优化，减小了锁粒度，增加了令牌桶，增大了并发量，隔绝了大部分无效请求。但是实际的购票流程是相同的。</p><h3 id="controller" tabindex="-1"><a class="header-anchor" href="#controller" aria-hidden="true">#</a> Controller</h3><p>在Controller层存在幂等检查，具体使用如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ILog</span>
<span class="token annotation punctuation">@Idempotent</span><span class="token punctuation">(</span>
        uniqueKeyPrefix <span class="token operator">=</span> <span class="token string">&quot;railway-ticket:lock_purchase-tickets:&quot;</span><span class="token punctuation">,</span>
        key <span class="token operator">=</span> <span class="token string">&quot;T(com.zzys.railway.framework.starter.user.core.UserContext).getUsername()&quot;</span><span class="token punctuation">,</span>
        message <span class="token operator">=</span> <span class="token string">&quot;正在执行下单流程，请稍后...&quot;</span><span class="token punctuation">,</span>
        scene <span class="token operator">=</span> <span class="token class-name">IdempotentSceneEnum</span><span class="token punctuation">.</span><span class="token constant">RESTAPI</span><span class="token punctuation">,</span>
        type <span class="token operator">=</span> <span class="token class-name">IdempotentTypeEnum</span><span class="token punctuation">.</span><span class="token constant">SPEL</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/ticket-service/ticket/purchase&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TicketPurchaseRespDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">purchaseTickets</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">PurchaseTicketReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>ticketService<span class="token punctuation">.</span><span class="token function">purchaseTicketsV1</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们在这里使用的是幂等组件库中的基于SPEL的REST场景下的幂等处理，本质上是以用户名为标识加上分布式锁，防止重复购票。</p><h3 id="责任链" tabindex="-1"><a class="header-anchor" href="#责任链" aria-hidden="true">#</a> 责任链</h3><p>V1和V2都会通过一条责任链：</p><p>首先是参数的判空校验，正确性校验（列车是否存在，购票时间是否正确，车站是否存在车次中，以及车站的顺序是否正确）。</p><p>然后就是判断余票是否充足，如果用户提交多个乘车人非同一座位类型，拆分验证。一个订单中的子订单只有座位类型可能不同，其他都相同。</p><p>假设下面是一个订单，那么每个子项都是一个子订单</p><ul><li>列车1-北京南-南京南-车厢1-商务座-座位1</li><li>列车1-北京南-南京南-车厢1-商务座-座位2</li><li>列车1-北京南-南京南-车厢2-二等座-座位1</li></ul><p>上面的情况就会查询以下的Redis缓存，hash的key是：列车1-北京南-南京南</p><ul><li>商务座：2</li><li>二等座：1</li></ul><h3 id="v1" tabindex="-1"><a class="header-anchor" href="#v1" aria-hidden="true">#</a> V1</h3><p>V1很暴力，每当一个订单在创建时，我们就对整个列车加分布式锁，也就是说，每辆列车同时只能有一个人选座。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">TicketPurchaseRespDTO</span> <span class="token function">purchaseTicketsV1</span><span class="token punctuation">(</span><span class="token class-name">PurchaseTicketReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 责任链模式，验证 1：参数必填 2：参数正确性 3：乘客是否已买当前车次等...</span>
    purchaseTicketAbstractChainContext<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">TicketChainMarkEnum</span><span class="token punctuation">.</span><span class="token constant">TRAIN_PURCHASE_TICKET_FILTER</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token constant">LOCK_PURCHASE_TICKETS</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ticketService<span class="token punctuation">.</span><span class="token function">executePurchaseTickets</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="v2" tabindex="-1"><a class="header-anchor" href="#v2" aria-hidden="true">#</a> V2</h3><h4 id="锁粒度的改变" tabindex="-1"><a class="header-anchor" href="#锁粒度的改变" aria-hidden="true">#</a> 锁粒度的改变</h4><p>如果有一人选择的是二等座，另一个人选择同一辆车的商务座，我们发现其实这两个请求是可以并发执行的。所以说，我们不应该对整个列车加锁，而是对座位类型加锁。</p><p>这里又引出了死锁的问题，我们破坏环路等待条件，在加锁时，都按照座位类型按序获取（0-商务座，1-一等座，2-二等座）。这样可以避免死锁。</p><h4 id="令牌桶" tabindex="-1"><a class="header-anchor" href="#令牌桶" aria-hidden="true">#</a> 令牌桶</h4><p>我们可以发现，假设train1-北京南-南京南-二等座一共就只有2张票，但是在V1版本下，100个请求过来买这类票，我们仍然需要对当前列车获取100次分布式锁，其实其中的98次分布式锁的获取是不必须的。我们可以利用限流算法，对无效请求进行隔离。</p><p>在这里我们使用的是类似令牌桶的算法，但是我们的令牌是不会增加的，每天会刷新令牌桶中的余票。</p><p>令牌桶实际上是Redis中的Hash结构，每一趟列车都是一个Hash。在其中包含着这一条路线中的所有逻辑路线和座位类型的笛卡尔积的余票数量。</p><p>我们使用lua脚本对每次取出一个逻辑线路的指定座位类型的影响进行改变，比较绕，举个例子：</p><p>假设我们买了列车2的从南京南到杭州东的商务座，原始bucket如下所示：</p><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/9b134b4f5d766afc2ad50779ff8bc41d.png" alt="" loading="lazy"></p><p>那么之后我们不仅要对<code>南京南_杭州东_0</code>的余票减一，对<code>南京南_上海虹桥_0</code>的余票也要减一，我们使用lua脚本保证执行的原子性。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">takeTokenFromBucket</span><span class="token punctuation">(</span><span class="token class-name">PurchaseTicketReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 前面这一部分主要是对令牌桶的获取</span>
    <span class="token comment">// 以及当令牌桶不存在时，采用分布式双重判定锁初始化的步骤</span>
    <span class="token class-name">TrainDO</span> trainDO <span class="token operator">=</span> distributedCache<span class="token punctuation">.</span><span class="token function">safeGet</span><span class="token punctuation">(</span>
            <span class="token constant">TRAIN_INFO</span> <span class="token operator">+</span> requestParam<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">TrainDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> trainMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token constant">ADVANCE_TICKET_DAY</span><span class="token punctuation">,</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteDTO</span><span class="token punctuation">&gt;</span></span> routeDTOList <span class="token operator">=</span> trainStationService
            <span class="token punctuation">.</span><span class="token function">listTrainStationRoute</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> trainDO<span class="token punctuation">.</span><span class="token function">getStartStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> trainDO<span class="token punctuation">.</span><span class="token function">getEndStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">)</span> distributedCache<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> actualHashKey <span class="token operator">=</span> <span class="token constant">TICKET_AVAILABILITY_TOKEN_BUCKET</span> <span class="token operator">+</span> requestParam<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> hasKey <span class="token operator">=</span> distributedCache<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>actualHashKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token constant">LOCK_TICKET_AVAILABILITY_TOKEN_BUCKET</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Boolean</span> hasKeyTwo <span class="token operator">=</span> distributedCache<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>actualHashKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasKeyTwo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> seatTypes <span class="token operator">=</span> <span class="token class-name">VehicleTypeEnum</span><span class="token punctuation">.</span><span class="token function">findSeatTypesByCode</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getTrainType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ticketAvailabilityTokenMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RouteDTO</span> each <span class="token operator">:</span> routeDTOList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeatTypeCountDTO</span><span class="token punctuation">&gt;</span></span> seatTypeCountDTOList <span class="token operator">=</span> seatMapper<span class="token punctuation">.</span><span class="token function">listSeatTypeCount</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getStartStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getEndStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seatTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SeatTypeCountDTO</span> eachSeatTypeCountDTO <span class="token operator">:</span> seatTypeCountDTOList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">String</span> buildCacheKey <span class="token operator">=</span> <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getStartStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getEndStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>eachSeatTypeCountDTO<span class="token punctuation">.</span><span class="token function">getSeatType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        ticketAvailabilityTokenMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>buildCacheKey<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>eachSeatTypeCountDTO<span class="token punctuation">.</span><span class="token function">getSeatCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token constant">TICKET_AVAILABILITY_TOKEN_BUCKET</span> <span class="token operator">+</span> requestParam<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ticketAvailabilityTokenMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取lua脚本</span>
    <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> actual <span class="token operator">=</span> <span class="token function">getLuaScript</span><span class="token punctuation">(</span><span class="token constant">LUA_TICKET_AVAILABILITY_TOKEN_BUCKET_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// [座位类型: 座位数量] [{0:1},{1:2}]</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> seatTypeCountMap <span class="token operator">=</span> requestParam<span class="token punctuation">.</span><span class="token function">getPassengers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span><span class="token class-name">PurchaseTicketPassengerDetailDTO</span><span class="token operator">::</span><span class="token function">getSeatType</span><span class="token punctuation">,</span> <span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">counting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将其转换为JSONArray形式</span>
    <span class="token class-name">JSONArray</span> seatTypeCountArray <span class="token operator">=</span> <span class="token class-name">Map2JSONArray</span><span class="token punctuation">(</span>seatTypeCountMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取到起始站到终点站所经过的所有逻辑路线</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteDTO</span><span class="token punctuation">&gt;</span></span> takeoutRouteDTOList <span class="token operator">=</span> trainStationService
            <span class="token punctuation">.</span><span class="token function">listTrainStationRoute</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> luaScriptKey <span class="token operator">=</span> <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用lua脚本 KEY：令牌桶id，HashKey的前缀（北京南_南京南） ARGV: 座位数量集合，沿途逻辑路线</span>
    <span class="token class-name">Long</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>actual<span class="token punctuation">,</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>actualHashKey<span class="token punctuation">,</span> luaScriptKey<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>seatTypeCountArray<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>takeoutRouteDTOList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 成功返回0</span>
    <span class="token keyword">return</span> result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是lua脚本逻辑，注释写的很详细。</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- Lua脚本，用于检查和更新票务系统中的座位可用性</span>

<span class="token comment">-- 从Redis命令参数（KEYS数组）中提取第二个键 北京南_南京南</span>
<span class="token keyword">local</span> inputString <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

<span class="token comment">-- 初始化处理键的变量</span>
<span class="token keyword">local</span> actualKey <span class="token operator">=</span> inputString
<span class="token keyword">local</span> colonIndex <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>actualKey<span class="token punctuation">,</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span>

<span class="token comment">-- 检查键是否包含冒号，如果是，则提取冒号后的子串</span>
<span class="token keyword">if</span> colonIndex <span class="token operator">~=</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
    actualKey <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>actualKey<span class="token punctuation">,</span> colonIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 解码作为第一个参数传递的JSON数组（ARGV数组） [0(商务座):1(数量),1:2]</span>
<span class="token keyword">local</span> jsonArrayStr <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">local</span> jsonArray <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>jsonArrayStr<span class="token punctuation">)</span>

<span class="token comment">-- 遍历JSON数组以检查座位的可用性</span>
<span class="token keyword">for</span> index<span class="token punctuation">,</span> jsonObj <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>jsonArray<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">local</span> seatType <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">.</span>seatType<span class="token punctuation">)</span>
    <span class="token keyword">local</span> count <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
    <span class="token comment">-- 北京南_南京南_0</span>
    <span class="token keyword">local</span> actualInnerHashKey <span class="token operator">=</span> actualKey <span class="token operator">..</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">..</span> seatType

    <span class="token comment">-- 从Redis哈希中获取当前座位可用性令牌值，KEYS[1]是当前列车的令牌桶key</span>
    <span class="token keyword">local</span> ticketSeatAvailabilityTokenValue <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;hget&#39;</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">tostring</span><span class="token punctuation">(</span>actualInnerHashKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">-- 检查可用座位是否少于请求的数量</span>
    <span class="token keyword">if</span> ticketSeatAvailabilityTokenValue <span class="token operator">&lt;</span> count <span class="token keyword">then</span>
        <span class="token keyword">return</span> <span class="token number">1</span> <span class="token comment">-- 表示座位不足</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 解码作为第二个参数传递的第二个JSON数组（ARGV数组）[北京南_南京南_0,南京南_上海虹桥_0]</span>
<span class="token keyword">local</span> alongJsonArrayStr <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token keyword">local</span> alongJsonArray <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>alongJsonArrayStr<span class="token punctuation">)</span>

<span class="token comment">-- 遍历第一个JSON数组并在Redis哈希中更新座位的可用性</span>
<span class="token keyword">for</span> index<span class="token punctuation">,</span> jsonObj <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>jsonArray<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">local</span> seatType <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">.</span>seatType<span class="token punctuation">)</span>
    <span class="token keyword">local</span> count <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">.</span>count<span class="token punctuation">)</span>

    <span class="token comment">-- 遍历第二个JSON数组以获取起始和终点站</span>
    <span class="token keyword">for</span> indexTwo<span class="token punctuation">,</span> alongJsonObj <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>alongJsonArray<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> startStation <span class="token operator">=</span> <span class="token function">tostring</span><span class="token punctuation">(</span>alongJsonObj<span class="token punctuation">.</span>startStation<span class="token punctuation">)</span>
        <span class="token keyword">local</span> endStation <span class="token operator">=</span> <span class="token function">tostring</span><span class="token punctuation">(</span>alongJsonObj<span class="token punctuation">.</span>endStation<span class="token punctuation">)</span>
        <span class="token keyword">local</span> actualInnerHashKey <span class="token operator">=</span> startStation <span class="token operator">..</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">..</span> endStation <span class="token operator">..</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">..</span> seatType

        <span class="token comment">-- 根据起始、终点站和座位类型在Redis哈希中减少座位计数</span>
        redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;hincrby&#39;</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">tostring</span><span class="token punctuation">(</span>actualInnerHashKey<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>count<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 返回0表示成功检查和更新座位的可用性</span>
<span class="token keyword">return</span> <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="本地锁" tabindex="-1"><a class="header-anchor" href="#本地锁" aria-hidden="true">#</a> 本地锁</h4><p>在分布式以及高并发的环境下，我们会发现每一次的有效请求都会向redis发起一次获取分布式锁的请求，我们可以让本地的线程先去争夺本地的锁，本地上锁成功后再去获取分布式锁。</p><p>我们可以类别，如果一个年纪有1000个人，有十个班，那么每个班就有100个人。当前要评审奖项，如果每个人都直接向年纪长发送请求，年纪长可能会忙不过来。所以我们可以让一个班的先去班级长处发送请求，在班级长这里获得通过后，再向年纪长发送请求，有点像缓存的概念。</p><p>但是这里又引出了死锁的问题，我们还是可以破坏环路等待的条件，对要获取的锁进行排序，首先每次先获取本地锁再获取分布式锁。</p><p>接着我们思考本地怎么存放锁，如果使用ConcurrentHashMap，我们会发现一旦我们删除列车数据或删除座位类型，我们没有很好的解决办法去删除对应的锁，最终可能占用内存过大或oom。所以我们采用了本地缓存组件Caffeine，设置过期时间为一天。</p><p>其实这个优化是不必须的，因为我们使用了令牌桶，有效的请求不会太多，这样Redis作为性能数据库，应该还是能够抗住这波削减后的流量的。</p><h4 id="end" tabindex="-1"><a class="header-anchor" href="#end" aria-hidden="true">#</a> End</h4><p>下面就是运用到以上三点后实现的V2版本，首先会去令牌桶获取令牌，隔绝大部分请求，接着就是对多把锁的获取，包括双重判定锁来初始化本地锁（有点绕），采用的是类对象来加锁</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">TicketPurchaseRespDTO</span> <span class="token function">purchaseTicketsV2</span><span class="token punctuation">(</span><span class="token class-name">PurchaseTicketReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">{</span> purchaseTicketAbstractChainContext<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">TicketChainMarkEnum</span><span class="token punctuation">.</span><span class="token constant">TRAIN_PURCHASE_TICKET_FILTER</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> tokenResult <span class="token operator">=</span> ticketAvailabilityTokenBucket<span class="token punctuation">.</span><span class="token function">takeTokenFromBucket</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tokenResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;列车站点已无余票&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReentrantLock</span><span class="token punctuation">&gt;</span></span> localLockList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RLock</span><span class="token punctuation">&gt;</span></span> distributedLockList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">PurchaseTicketPassengerDetailDTO</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> seatTypeMap <span class="token operator">=</span> requestParam<span class="token punctuation">.</span><span class="token function">getPassengers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span><span class="token class-name">PurchaseTicketPassengerDetailDTO</span><span class="token operator">::</span><span class="token function">getSeatType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">PurchaseTicketPassengerDetailDTO</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entryList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>seatTypeMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entryList<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">.</span><span class="token function">comparingByKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entryList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Integer</span> searType <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token constant">LOCK_PURCHASE_TICKETS_V2</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> searType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReentrantLock</span> localLock <span class="token operator">=</span> localLockMap<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>localLock <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">TicketService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>localLock <span class="token operator">=</span> localLockMap<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    localLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    localLockMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">,</span> localLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        localLockList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>localLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> distributedLock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getFairLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        distributedLockList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>distributedLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        localLockList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">ReentrantLock</span><span class="token operator">::</span><span class="token function">lock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        distributedLockList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">RLock</span><span class="token operator">::</span><span class="token function">lock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ticketService<span class="token punctuation">.</span><span class="token function">executePurchaseTickets</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        localLockList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>localLock <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                localLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        distributedLockList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>distributedLock <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                distributedLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="购票流程" tabindex="-1"><a class="header-anchor" href="#购票流程" aria-hidden="true">#</a> 购票流程</h3><p><code>executePurchaseTickets</code>方法就是具体的购票流程，V1和V2版本都是相同的，这里需要注意不能直接调用方法，否则会事务失效，需要注入。</p><p>由于代码大多数都是装填对象，我就直接说一下思路：</p><ul><li>首先通过TrainSeatTypeSelector#select方法自动分配座位（TrainSeatTypeSelector是自定义的座位选择器），同时对座位上锁。</li><li>创建票务对象，批量插入数据库。</li><li>RPC调用Order服务。</li></ul><h3 id="trainseattypeselector" tabindex="-1"><a class="header-anchor" href="#trainseattypeselector" aria-hidden="true">#</a> TrainSeatTypeSelector</h3><p>我们这里来说一下座位选择器，我们只了解它的选择运行架构，而不去真正的学习它的选择底层实现（代码太长了）。</p><ol><li><p>如果一个订单中有超过两种座位类型选票，那么我们会采用线程池去计算不同座位类型的选座（选座算法的时间复杂度较高，同时也存在多次的数据库读），同时采用并行流获取数据。</p></li><li><p>分配完毕座位后，我们会去远程调用一下用户服务，判断每个乘车人都已经在数据库中登记过并且审核过。</p></li><li><p>我们对座位进行锁定。</p></li></ol><p>对于第一点，我们的更详细的操作步骤是：</p><ul><li><p>调用选座算法进行选座</p></li><li><p>扣减余票缓存，但是我们需要先判断一下缓存更新的类型，如果项目采用的是监听binlog+RocketMQ，那么我们就无需手动扣减，我们扣减的就是下图的Redis结构：</p><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/32ece7cfea092096f407e768ac68b771.png" alt="" loading="lazy"></p></li></ul></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 2803436425@qq.com">YangZhang</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/project/12306/service/%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1.html" class="" aria-label="订单服务"><!--[--><!--]--> 订单服务 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app-20538318.js" defer></script>
  </body>
</html>
