import{_ as s,o as n,c as a,e}from"./app-20538318.js";const p={},o=e(`<p>本章介绍有关于MySQL锁的相关知识。</p><p>MySQL中，锁分为以下三种：</p><ul><li>全局锁</li><li>表级锁</li><li>行级锁（Innodb）</li></ul><h2 id="全局锁" tabindex="-1"><a class="header-anchor" href="#全局锁" aria-hidden="true">#</a> 全局锁</h2><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/170111588ec5b2a92b7348cc734fb906.png" alt="image-20230908203459159" loading="lazy"></p><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/4b42951b460a0232f2e1a2694782ba9b.png" alt="image-20230908203522385" loading="lazy"></p><h2 id="表级锁" tabindex="-1"><a class="header-anchor" href="#表级锁" aria-hidden="true">#</a> 表级锁</h2><p>每次操作锁住整张表，粒度很大，并发低。分为以下三类：</p><ul><li>表锁</li><li>元数据锁</li><li>意向锁</li></ul><h3 id="表锁" tabindex="-1"><a class="header-anchor" href="#表锁" aria-hidden="true">#</a> 表锁</h3><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/d8bde749c76fcc5bfc3f7e9af8592e32.png" alt="" loading="lazy"></p><h3 id="元数据锁" tabindex="-1"><a class="header-anchor" href="#元数据锁" aria-hidden="true">#</a> 元数据锁</h3><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/8b289ac50efa574bfaa7c6ef9e75cf79.png" alt="image-20230908204149913" loading="lazy"></p><h3 id="意向锁" tabindex="-1"><a class="header-anchor" href="#意向锁" aria-hidden="true">#</a> 意向锁</h3><p>防止在加入表锁时，需要全表扫描是否存在行锁，所以在加行锁时，会默认同时加上意向锁。</p><ul><li>意向共享锁（IS）：由<code>select * from table lock in shared mode</code>添加。</li><li>意向排他锁（IX）：由<code>update,delete,insert,select...fro update</code>添加。</li></ul><table><thead><tr><th style="text-align:center;">意向锁\\表锁</th><th style="text-align:center;">read</th><th style="text-align:center;">write</th><th style="text-align:center;">意向锁</th></tr></thead><tbody><tr><td style="text-align:center;">IS</td><td style="text-align:center;">共享</td><td style="text-align:center;">互斥</td><td style="text-align:center;">共享</td></tr><tr><td style="text-align:center;">IX</td><td style="text-align:center;">互斥</td><td style="text-align:center;">互斥</td><td style="text-align:center;">共享</td></tr></tbody></table><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/8a138fb68ce7e8a6f113d712920f991c.png" alt="image-20230908204839835" loading="lazy"></p><h2 id="行级锁" tabindex="-1"><a class="header-anchor" href="#行级锁" aria-hidden="true">#</a> 行级锁</h2><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/48f65a462486617b75d60d839ddfaa7a.png" alt="image-20230908204939478" loading="lazy"></p><p>Innodb默认运行在RR的隔离级别下，该级别下使用临建锁来防止幻读。</p><p><strong>行锁</strong></p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/58754f55ef08652288b9be83d53f9d96.png" alt="image-20230908205041267" style="zoom:67%;"><p><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/4f3db37d4fac220fa2a19f8c7c50d755.png" alt="image-20230908205126127" loading="lazy"></p><h3 id="rr下的运行说明" tabindex="-1"><a class="header-anchor" href="#rr下的运行说明" aria-hidden="true">#</a> RR下的运行说明</h3><p>在RR级别下，InnoDB默认使用<strong>next-key</strong>进行搜索和扫描，也就是说，在加行级锁时，默认会对记录和前面的间隙都加锁，以防止幻读的发生。</p><p>但是会有以下的特殊情况，假设有这么一张表：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>test<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>age<span class="token punctuation">\`</span></span> <span class="token keyword">int</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>idx_test_age<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>age<span class="token punctuation">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_0900_ai_ci<span class="token punctuation">;</span>

<span class="token comment">-- 数据如下：</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span> age  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> a    <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> b    <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> g    <span class="token operator">|</span>    <span class="token number">7</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> s    <span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">6</span> <span class="token operator">|</span> t    <span class="token operator">|</span>   <span class="token number">10</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>InnoDB是对索引进行加锁，所以如果没有按照索引进行查询数据，就会升级为表锁，对所有记录加锁。</p><p>supremum pseudo-record 用来指代最后一条记录后面的间隙。</p></blockquote><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;a&#39;</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span> age  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> a    <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> object_schema<span class="token punctuation">,</span>object_name<span class="token punctuation">,</span>index_name<span class="token punctuation">,</span>lock_type<span class="token punctuation">,</span>lock_mode<span class="token punctuation">,</span>lock_data <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>data_locks<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+-----------+------------------------+</span>
<span class="token operator">|</span> object_schema <span class="token operator">|</span> object_name <span class="token operator">|</span> index_name <span class="token operator">|</span> lock_type <span class="token operator">|</span> lock_mode <span class="token operator">|</span> lock_data              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+-----------+------------------------+</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">TABLE</span>     <span class="token operator">|</span> IX        <span class="token operator">|</span> <span class="token boolean">NULL</span>                   <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X         <span class="token operator">|</span> supremum pseudo<span class="token operator">-</span>record <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X         <span class="token operator">|</span> <span class="token number">1</span>                      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X         <span class="token operator">|</span> <span class="token number">2</span>                      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X         <span class="token operator">|</span> <span class="token number">4</span>                      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X         <span class="token operator">|</span> <span class="token number">3</span>                      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X         <span class="token operator">|</span> <span class="token number">6</span>                      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+-----------+------------------------+</span>
<span class="token number">7</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>对唯一索引的等值匹配，对于已存在的的记录，默认优化为行锁。</p></blockquote><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span> age  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> a    <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> object_schema<span class="token punctuation">,</span>object_name<span class="token punctuation">,</span>index_name<span class="token punctuation">,</span>lock_type<span class="token punctuation">,</span>lock_mode<span class="token punctuation">,</span>lock_data <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>data_locks<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+---------------+-----------+</span>
<span class="token operator">|</span> object_schema <span class="token operator">|</span> object_name <span class="token operator">|</span> index_name <span class="token operator">|</span> lock_type <span class="token operator">|</span> lock_mode     <span class="token operator">|</span> lock_data <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+---------------+-----------+</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">TABLE</span>     <span class="token operator">|</span> IX            <span class="token operator">|</span> <span class="token boolean">NULL</span>      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X<span class="token punctuation">,</span>REC_NOT_GAP <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+---------------+-----------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>对唯一索引的等值匹配，对于不存在的记录，优化为间隙锁。</p></blockquote><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">5</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span>
Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> object_schema<span class="token punctuation">,</span>object_name<span class="token punctuation">,</span>index_name<span class="token punctuation">,</span>lock_type<span class="token punctuation">,</span>lock_mode<span class="token punctuation">,</span>lock_data <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>data_locks<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+-----------+-----------+</span>
<span class="token operator">|</span> object_schema <span class="token operator">|</span> object_name <span class="token operator">|</span> index_name <span class="token operator">|</span> lock_type <span class="token operator">|</span> lock_mode <span class="token operator">|</span> lock_data <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+-----------+-----------+</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">TABLE</span>     <span class="token operator">|</span> <span class="token operator">IS</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> RECORD    <span class="token operator">|</span> S<span class="token punctuation">,</span>GAP     <span class="token operator">|</span> <span class="token number">6</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+-----------+-----------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>	

mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>对于非唯一索引的等值查询，采用临建锁和间隙锁共同加锁</p></blockquote><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment">--  测试单条数据</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">5</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span> age  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> s    <span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> object_schema<span class="token punctuation">,</span>object_name<span class="token punctuation">,</span>index_name<span class="token punctuation">,</span>lock_type<span class="token punctuation">,</span>lock_mode<span class="token punctuation">,</span>lock_data <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>data_locks<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+--------------+-----------+---------------+-----------+</span>
<span class="token operator">|</span> object_schema <span class="token operator">|</span> object_name <span class="token operator">|</span> index_name   <span class="token operator">|</span> lock_type <span class="token operator">|</span> lock_mode     <span class="token operator">|</span> lock_data <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+--------------+-----------+---------------+-----------+</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token boolean">NULL</span>         <span class="token operator">|</span> <span class="token keyword">TABLE</span>     <span class="token operator">|</span> IX            <span class="token operator">|</span> <span class="token boolean">NULL</span>      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> idx_test_age <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X             <span class="token operator">|</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span>      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>      <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X<span class="token punctuation">,</span>REC_NOT_GAP <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> idx_test_age <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X<span class="token punctuation">,</span>GAP         <span class="token operator">|</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+--------------+-----------+---------------+-----------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">insert</span> <span class="token keyword">into</span> test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">&#39;n&#39;</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment">-- 测试多条数据</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">5</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span> age  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> s    <span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> n    <span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> object_schema<span class="token punctuation">,</span>object_name<span class="token punctuation">,</span>index_name<span class="token punctuation">,</span>lock_type<span class="token punctuation">,</span>lock_mode<span class="token punctuation">,</span>lock_data <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>data_locks<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+--------------+-----------+---------------+-----------+</span>
<span class="token operator">|</span> object_schema <span class="token operator">|</span> object_name <span class="token operator">|</span> index_name   <span class="token operator">|</span> lock_type <span class="token operator">|</span> lock_mode     <span class="token operator">|</span> lock_data <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+--------------+-----------+---------------+-----------+</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token boolean">NULL</span>         <span class="token operator">|</span> <span class="token keyword">TABLE</span>     <span class="token operator">|</span> IX            <span class="token operator">|</span> <span class="token boolean">NULL</span>      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> idx_test_age <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X             <span class="token operator">|</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span>      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> idx_test_age <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X             <span class="token operator">|</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span>      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>      <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X<span class="token punctuation">,</span>REC_NOT_GAP <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>      <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X<span class="token punctuation">,</span>REC_NOT_GAP <span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> idx_test_age <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X<span class="token punctuation">,</span>GAP         <span class="token operator">|</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+--------------+-----------+---------------+-----------+</span>
<span class="token number">6</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://blog-zzys.oss-cn-beijing.aliyuncs.com/articles/31ef88e1ef2ed74c9cb7dda8e3806ec3.png" style="zoom:67%;"><blockquote><p>唯一索引的范围查询，采用临建锁和间隙锁共同加锁。</p></blockquote><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> id <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">and</span> id <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span> age  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> g    <span class="token operator">|</span>    <span class="token number">7</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> s    <span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> id <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">and</span> id <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span> age  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> g    <span class="token operator">|</span>    <span class="token number">7</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> s    <span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> object_schema<span class="token punctuation">,</span>object_name<span class="token punctuation">,</span>index_name<span class="token punctuation">,</span>lock_type<span class="token punctuation">,</span>lock_mode<span class="token punctuation">,</span>lock_data <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>data_locks<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+-----------+-----------+</span>
<span class="token operator">|</span> object_schema <span class="token operator">|</span> object_name <span class="token operator">|</span> index_name <span class="token operator">|</span> lock_type <span class="token operator">|</span> lock_mode <span class="token operator">|</span> lock_data <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+-----------+-----------+</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">TABLE</span>     <span class="token operator">|</span> IX        <span class="token operator">|</span> <span class="token boolean">NULL</span>      <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X         <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X         <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span>
<span class="token operator">|</span> test          <span class="token operator">|</span> test        <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> RECORD    <span class="token operator">|</span> X<span class="token punctuation">,</span>GAP     <span class="token operator">|</span> <span class="token number">6</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+------------+-----------+-----------+-----------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,39),t=[o];function c(l,r){return n(),a("div",null,t)}const i=s(p,[["render",c],["__file","锁.html.vue"]]);export{i as default};
